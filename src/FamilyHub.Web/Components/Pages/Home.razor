@page "/"
@using FamilyHub.Application.Features.Tasks
@using FamilyHub.Application.Features.Members
@using Mediator
@inject ISender Sender

<!--
    Page d'accueil de FamilyHub.
    Affiche un tableau de bord avec les statistiques de la famille.

    CQRS: Au lieu d'injecter des services specifiques (TaskService, MemberService),
    on injecte ISender. C'est le point d'entree unique du Mediator.

    ISender.Send() envoie une commande ou requete au Mediator,
    qui la route automatiquement vers le bon handler.

    Avantage : la page ne depend plus de services concrets,
    elle depend uniquement de l'interface ISender (decouplage maximal).
-->

<h1>Bienvenue sur FamilyHub</h1>
<p class="lead">Votre assistant de gestion familiale</p>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Membres</h5>
                <p class="card-text display-4">@_memberCount</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Taches actives</h5>
                <p class="card-text display-4">@_activeTaskCount</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">Taches en retard</h5>
                <p class="card-text display-4">@_overdueCount</p>
            </div>
        </div>
    </div>
</div>

@if (_overdueTasks.Any())
{
    <div class="alert alert-warning mt-3">
        <h5>Taches en retard :</h5>
        <ul>
            @foreach (var task in _overdueTasks)
            {
                <li>
                    <strong>@task.Title</strong>
                    - Echeance : @task.DueDate?.ToString("dd/MM/yyyy")
                    @if (task.AssignedToName is not null)
                    {
                        <span class="text-muted">(@task.AssignedToName)</span>
                    }
                </li>
            }
        </ul>
    </div>
}

@code {
    private int _memberCount;
    private int _activeTaskCount;
    private int _overdueCount;
    private IReadOnlyList<TaskDto> _overdueTasks = [];

    // OnInitializedAsync : appele une seule fois quand le composant est cree
    protected override async Task OnInitializedAsync()
    {
        // CQRS: On envoie des requetes (Queries) via ISender
        // Le Mediator route chaque requete vers le bon QueryHandler
        var membersResult = await Sender.Send(new GetMembers());
        var tasksResult = await Sender.Send(new GetTasks());
        var overdueResult = await Sender.Send(new GetTasks(OverdueOnly: true));

        // CQRS: On verifie le resultat avant d'utiliser les donnees
        if (membersResult.IsSuccess)
            _memberCount = membersResult.Value.Count;

        if (tasksResult.IsSuccess)
            _activeTaskCount = tasksResult.Value.Count(t => t.Status != FamilyTaskStatus.Done);

        if (overdueResult.IsSuccess)
        {
            _overdueTasks = overdueResult.Value;
            _overdueCount = _overdueTasks.Count;
        }
    }
}
